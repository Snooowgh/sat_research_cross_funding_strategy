# 增强通知系统文档

## 概述

本文档描述了对 `arbitrage_process_main.py` 的增强通知系统，该系统提供了更全面的监控和告警功能。

## 新增功能

### 1. 交易数据监控

每个交易进程现在会收集和报告以下交易数据：

- **开仓信号数量**: 记录每个引擎执行的总交易次数
- **平均交易额**: 计算每笔交易的平均金额
- **累计成交额**: 显示总交易金额
- **最新平均价差 (ma_spread)**: 实时显示当前市场的平均价差
- **最新费率差APY**: 显示两个交易所之间的资金费率差异

### 2. 系统负载监控

系统会持续监控操作系统资源使用情况：

- **CPU使用率**: 监控CPU占用，默认阈值80%
- **内存使用率**: 监控内存占用，默认阈值85%
- **磁盘使用率**: 监控磁盘空间，默认阈值90%
- **系统负载**: 监控系统平均负载（Unix系统）

### 3. 进程重启原因告警

- **崩溃检测**: 自动检测引擎进程崩溃并记录退出码
- **重启记录**: 详细记录每次重启的原因和时间
- **重启限制**: 当达到最大重启次数时停止重启并告警

### 4. 系统错误告警推送

- **实时错误收集**: 收集所有系统级错误
- **分级告警**: 根据错误严重性发送不同级别的通知
- **错误历史**: 保留最近的错误记录用于分析

## 配置选项

在 `ManagerConfig` 类中新增了以下配置选项：

```python
# 系统监控配置
enable_system_monitor: bool = True           # 是否启用系统监控
cpu_threshold: float = 80.0                  # CPU使用率告警阈值(%)
memory_threshold: float = 85.0               # 内存使用率告警阈值(%)
disk_threshold: float = 90.0                 # 磁盘使用率告警阈值(%)
error_log_retention_count: int = 10          # 错误日志保留数量
```

## 通知格式

增强后的状态通知包含以下信息：

```
📊 套利管理器智能状态报告
🤖 活跃引擎: 5 (健康: 4)
🚀 总启动/重启: 15/3
💾 平均内存: 256MB
🔄 最大重启次数: 2
🕐 风控更新: 14:30:25
⏱️ 运行时长: 125分钟

💻 系统负载:
   CPU: 45.2% | 内存: 67.8% | 磁盘: 23.4%
   负载: 1.23/1.45/1.67

📈 交易统计汇总:
   总交易: 156笔 | 总成交额: $125,678
   平均交易额: $806 | 活跃引擎: 4/5

🔍 引擎详情:
✅ BTC_binance_hyperliquid 234MB 📈12笔 $850 价差:0.15% 费率:2.3%apy
✅ ETH_binance_lighter 189MB 📈8笔 $720 价差:0.12% 费率:1.8%apy
❌ SOL_hyperliquid_lighter 456MB(1重启) 📭无交易 | 进程异常退出 (退出码: 1)

⚠️ 最近错误:
   14:25:10 [SOL_hyperliquid_lighter] ENGINE_CRASH: 进程崩溃，退出码: 1
   14:22:45 [SOL_hyperliquid_lighter] ENGINE_RESTART: 重启成功 (第1次) - 原因: 进程异常退出 (退出码: 1)
```

## 实现细节

### 数据收集机制

1. **共享内存通信**: 引擎进程通过多进程共享字典定期更新交易统计
2. **定期同步**: 每10秒同步一次交易数据到管理器
3. **错误缓冲**: 使用环形缓冲区存储最近的错误日志

### 告警分级

- **紧急告警** (立即发送): ENGINE_CRASH, SYSTEM_ERROR, RESTART_FAILED
- **重要告警** (状态通知中显示): ENGINE_RESTART, HIGH_CPU_USAGE, HIGH_MEMORY_USAGE
- **一般信息** (状态通知中显示): 正常重启、系统负载信息

## 使用方法

增强的通知系统会自动启动，无需额外配置。如需自定义设置，可以修改 `ManagerConfig` 的相关参数：

```python
config = ManagerConfig(
    enable_system_monitor=True,
    cpu_threshold=75.0,        # 降低CPU告警阈值
    memory_threshold=80.0,     # 降低内存告警阈值
    error_log_retention_count=15  # 保留更多错误日志
)

manager = MultiProcessArbitrageManager(config)
```

## 注意事项

1. **psutil依赖**: 系统监控功能需要安装 `psutil` 库
2. **性能影响**: 数据收集会带来轻微的性能开销，但通过异步处理最小化影响
3. **通知频率**: 状态通知默认每30分钟发送一次，避免通知轰炸
4. **错误过滤**: 系统会智能过滤重复的错误，避免告警泛滥

## 故障排除

### psutil未安装
```
pip install psutil
```

### 通知过于频繁
调整 `notify_interval_min` 参数增加通知间隔

### 某些监控数据缺失
检查相关权限和系统兼容性，某些指标在特定系统上可能不可用